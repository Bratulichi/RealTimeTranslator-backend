name: Version Bump

on:
  push:
    branches: [ "develop" ]

jobs:
  version-bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install toml
        run: pip install toml

      - name: Get commits and bump version
        run: |
          echo "=== Getting commits to analyze ==="
          
          # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç —Å version bump (–µ—Å–ª–∏ –µ—Å—Ç—å)
          LAST_VERSION_COMMIT=$(git log --oneline --grep="bump version" -n 1 --pretty=format:"%H" || echo "")
          
          if [ -n "$LAST_VERSION_COMMIT" ]; then
            echo "Last version bump commit: $LAST_VERSION_COMMIT"
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ version bump –¥–æ HEAD
            COMMITS_RANGE="${LAST_VERSION_COMMIT}..HEAD"
          else
            echo "No previous version bump found, analyzing last 10 commits"
            # –ï—Å–ª–∏ version bump –∫–æ–º–º–∏—Ç–æ–≤ –Ω–µ –±—ã–ª–æ, –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∫–æ–º–º–∏—Ç–æ–≤
            COMMITS_RANGE="HEAD~10..HEAD"
          fi
          
          echo "Analyzing commits in range: $COMMITS_RANGE"
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–∏—Ç–æ–≤
          COMMITS=$(git log --pretty=format:"%s" $COMMITS_RANGE | grep -v "bump version" || echo "")
          
          if [ -z "$COMMITS" ]; then
            echo "No commits to analyze"
            exit 0
          fi
          
          echo "Commits to analyze:"
          echo "$COMMITS"
          echo ""
          
          # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è Python
          export COMMITS="$COMMITS"
          
          python << 'EOF'
          import toml
          import os
          import re
          from pathlib import Path
          
          # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–º–∏—Ç—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
          commits_text = os.environ.get('COMMITS', '').strip()
          if not commits_text:
              print("No commits to analyze")
              exit(0)
              
          commits = [line.strip() for line in commits_text.split('\n') if line.strip()]
          
          print(f"Analyzing {len(commits)} commits:")
          for i, commit in enumerate(commits, 1):
              print(f"  {i}. {commit}")
          
          # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞)
          pyproject_path = Path("pyproject.toml")
          data = toml.load(pyproject_path)
          current_version = data["project"]["version"]
          print(f"\nCurrent version: {current_version}")
          
          version_parts = current_version.split(".")
          major, minor, patch = int(version_parts[0]), int(version_parts[1]), int(version_parts[2])
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–º–∏—Ç—ã
          has_major = False
          has_minor = False  
          has_fix = False
          
          for commit in commits:
              if commit.startswith("[major]"):
                  has_major = True
                  print(f"  ‚Üí Found [major]: {commit}")
              elif commit.startswith("[minor]"):
                  has_minor = True
                  print(f"  ‚Üí Found [minor]: {commit}")
              elif commit.startswith("[fix]"):
                  has_fix = True
                  print(f"  ‚Üí Found [fix]: {commit}")
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–≤—ã—à–µ–Ω–∏—è
          if has_major:
              major += 1
              minor = 0
              patch = 0
              bump_type = "major"
              print(f"\nüöÄ MAJOR version bump: {current_version} ‚Üí {major}.{minor}.{patch}")
          elif has_minor:
              minor += 1
              patch = 0
              bump_type = "minor"
              print(f"\nüìà MINOR version bump: {current_version} ‚Üí {major}.{minor}.{patch}")
          elif has_fix:
              patch += 1
              bump_type = "patch"  
              print(f"\nüîß PATCH version bump: {current_version} ‚Üí {major}.{minor}.{patch}")
          else:
              print("\n‚ùå No version keywords found ([fix], [minor], [major]) - no version bump")
              exit(0)
          
          new_version = f"{major}.{minor}.{patch}"
          
          # === –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ ===
          # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ —Ç–µ–∫—Å—Ç –∏ –∑–∞–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É —Å –≤–µ—Ä—Å–∏–µ–π
          with open(pyproject_path, 'r', encoding='utf-8') as f:
              content = f.read()
          
          # –ò—â–µ–º –∏ –∑–∞–º–µ–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É version = "..." 
          version_pattern = r'^version\s*=\s*["\'][^"\']*["\']'
          new_version_line = f'version = "{new_version}"'
          
          updated_content = re.sub(version_pattern, new_version_line, content, flags=re.MULTILINE)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–º–µ–Ω–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞
          if updated_content == content:
              print("‚ùå Failed to update version in pyproject.toml")
              exit(1)
          
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          with open(pyproject_path, 'w', encoding='utf-8') as f:
              f.write(updated_content)
          
          print(f"‚úÖ Version updated in pyproject.toml: {current_version} ‚Üí {new_version}")
          print("üìù File formatting preserved!")
          
          # –°–æ–∑–¥–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
          with open("version_updated.flag", "w") as f:
              f.write(f"{new_version}\n{bump_type}")
          EOF

      - name: Commit version change
        run: |
          if [ -f "version_updated.flag" ]; then
            NEW_VERSION=$(head -n 1 version_updated.flag)
            BUMP_TYPE=$(tail -n 1 version_updated.flag)
            
            echo "Committing version bump to $NEW_VERSION"
            git config user.name github-actions
            git config user.email github-actions@github.com
            git add pyproject.toml
            git commit -m "chore: bump version to ${NEW_VERSION} (${BUMP_TYPE})"
            git push
            
            echo "‚úÖ Successfully committed version ${NEW_VERSION}"
          else
            echo "‚ÑπÔ∏è  No version update to commit"
          fi